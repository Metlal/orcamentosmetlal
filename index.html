<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Or√ßaf√°cil METLAL</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style> /* seu estilo aqui */ </style>
</head>
<body>
  <div class="container">
    <h2>Or√ßaf√°cil METLAL</h2>
    <label>Cliente:<input id="cliente"/></label>
    <label>N√∫mero:<input id="numero" readonly/></label>
    <label>Data:<input id="data" type="date"/></label>
    <label>Produto:<select id="produto"></select></label>
    <label>Quantidade:<input id="quantidade" type="number" value="1" min="1"/></label>
    <button onclick="adicionarItem()">Adicionar Produto</button>
    <div id="itens"></div>
    <p class="total" id="total">Total: R$‚ÄØ0,00</p>
    <button onclick="gerarPDF()">üìÖ Gerar PDF e Salvar</button>
  </div>

  <script>
    const webAppURL = "https://script.google.com/macros/s/AKfycbzgwZ3LxrA3Musm5pZcmiUUCwWqmPJLitEGG3JqPNVyP1w9WM4fVSsAQpoWy-Bn_IT9/exec";
   
    const produto = document.getElementById("produto");
    const cliente = document.getElementById("cliente");
    const numero = document.getElementById("numero");
    const data = document.getElementById("data");
    const quantidade = document.getElementById("quantidade");
    const itensDiv = document.getElementById("itens");
    const totalDisplay = document.getElementById("total");

    let produtos = {}, lista = [];

    carregarProdutos();
    gerarNumero();

    function carregarProdutos() {
      fetch(webAppURL + "?tipo=produtos")
        .then(r => r.json())
        .then(js => {
          produto.innerHTML = "<option value=''>Selecione um produto</option>";
          js.forEach(p => {
            produtos[p.nome] = parseFloat(p.preco);
            produto.innerHTML += `<option value="${p.nome}">${p.nome}</option>`;
          });
        })
        .catch(() => {
          produto.innerHTML = "<option>Erro ao carregar produtos</option>";
        });
    }

    function gerarNumero() {
      fetch(webAppURL + "?tipo=ultimo")
        .then(r => r.text())
        .then(text => {
          const num = text.match(/\d+/);
          const seq = num ? parseInt(num[0]) + 1 : 1;
          numero.value = `MT${String(seq).padStart(4, "0")}`;
        })
        .catch(() => numero.value = "MT0001");

      data.value = new Date().toISOString().substr(0,10);
    }

    function adicionarItem() {
      const n = produto.value, q = parseInt(quantidade.value);
      if (!n || q < 1) return alert("Selecione produto e quantidade.");
      const preco = produtos[n];
      lista.push({ nome: n, qtd: q, subtotal: preco * q });
      atualizarLista();
    }

    function atualizarLista() {
      let html = "<ul>", total = 0;
      lista.forEach((i, idx) => {
        total += i.subtotal;
        html += `<li>${i.nome} x${i.qtd} ‚Äì R$ ${i.subtotal.toFixed(2)} 
                  <button onclick="remover(${idx})">‚ùå</button></li>`;
      });
      html += "</ul>";
      itensDiv.innerHTML = html;
      totalDisplay.textContent = `Total: R$ ${total.toFixed(2)}`;
    }

    function remover(i) {
      lista.splice(i,1);
      atualizarLista();
    }

    function gerarPDF() {
      if (!cliente.value || lista.length == 0) 
        return alert("Preencha cliente e adicione itens.");

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text(`Cliente: ${cliente.value}`, 10, 20);
      doc.text(`Or√ßamento: ${numero.value} ‚Äì Data: ${data.value}`, 10, 26);

      let y=36, total=0;
      lista.forEach(it => {
        doc.text(`‚Ä¢ ${it.nome} x${it.qtd} ‚Äî R$${it.subtotal.toFixed(2)}`, 10, y);
        total += it.subtotal;
        y += 6;
      });
      doc.text(`Total: R$${total.toFixed(2)}`, 10, y+10);
      doc.save(`${numero.value}.pdf`);

      const produtosTexto = lista.map(i=>`${i.nome} (${i.qtd})`).join(" | ");
      fetch(webAppURL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
          tipo:"salvar",
          numero: numero.value,
          cliente: cliente.value,
          data: data.value,
          produtos: produtosTexto,
          total: total.toFixed(2),
          status: "Pendente",
          usuario: "admin"
        })
      })
      .then(r => r.text())
      .then(msg => alert(msg))
      .catch(e => alert("Erro ao salvar: "+e.message));
    }
  </script>
</body>
</html>
